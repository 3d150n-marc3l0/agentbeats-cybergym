FROM ghcr.io/astral-sh/uv:python3.13-bookworm

ENV UV_HTTP_TIMEOUT=300

RUN apt-get update && \
    apt-get install -y git git-lfs && \
    rm -rf /var/lib/apt/lists/*

RUN adduser agentbeats
USER agentbeats

RUN mkdir -p /home/agentbeats/.cache/uv
WORKDIR /home/agentbeats/agentx

COPY pyproject.toml uv.lock README.md ./
COPY src src

RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv sync --locked --no-dev --no-install-project --extra cybergym-green-agent

# Download cybergym data (subset)
RUN git lfs install --skip-smudge && \
    git clone --depth 1 https://huggingface.co/datasets/sunblaze-ucb/cybergym /home/agentbeats/cybergym_data && \
    cd /home/agentbeats/cybergym_data && \
    git lfs pull --include="data/arvo/47101/*" && \
    git lfs pull --include="data/arvo/3938/*"

ENV CYBERGYM_DATA=/home/agentbeats/cybergym_data/data

COPY scenarios scenarios

ENTRYPOINT ["uv", "run", "scenarios/cybergym/green-agent/src/server.py"]
CMD ["--host", "0.0.0.0"]
EXPOSE 9009